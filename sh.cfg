# Common functions/aliases for all shells

export EDITOR=vim

function qgrep() {
    echo "----------"
    grep -IRn --exclude-dir="*\.git*" --include=\*.{java,cpp,c,cc,h,hpp,xml,py,mk,sh,jinja} --include=Makefile --include=CMakeLists.txt --include=Jenkins\* --include=Dockerfile\* "$*"
}

function fixaudio() {
    pulseaudio -k
    sudo alsa force-reload
    aplay /usr/share/sounds/alsa/Front_Center.wav
}

function mntssh() {
    # call with arguments:
    # remote host, remote directory, local directory
    sshfs -o follow_symlinks -o idmap=user -o allow_other $1:$2 $3
}

function runchrome() {
    /opt/google/chrome/google-chrome --disk-cache-size=10000000 --bookmark-menu --touch-devices=123
}

function cfgup() {
    cd $JLDCFGDIR
    git pull
    git submodule init
    git submodule update --recursive --remote
    
    SHELLTYPE=$(basename "$SHELL")
    source $JLDCFGDIR/$SHELLTYPE.cfg
    echo "Use Ctrl-a r to reload tmux config"
}

function assh() {
    while true; do
        ssh "$@"
        echo "ssh exited, will retry in 5 seconds..."
        sleep 5
    done
}

function pathadd () {
    if ! echo "$PATH" | /bin/grep -Eq "(^|:)$1($|:)" ; then
       if [ "$2" = "after" ] ; then
          PATH="$PATH:$1"
       else
          PATH="$1:$PATH"
       fi
    fi
}

# tmux and keychain might be here
if [ -d $HOME/bin ]; then
  pathadd $HOME/bin
fi

# This is the systemd method:
# https://unix.stackexchange.com/questions/339840
if [ -f $XDG_RUNTIME_DIR/ssh-agent.socket ]; then
    if [ "" -eq $SSH_AUTH_SOCK ]; then
        export SSH_AUTH_SOCK="$XDG_RUNTIME_DIR/ssh-agent.socket"
    fi
else
# Use keychain if possible
    if [ -f $HOME/.ssh/id_rsa ]; then
        if command -v keychain &> /dev/null ; then
            eval `keychain -q --agents ssh --eval id_rsa`
        fi
    fi
fi

if command -v tmux &> /dev/null && [ -n "$PS1" ] && [[ ! "$TERM" =~ screen ]] && [[ ! "$TERM" =~ tmux ]] && [ -z "$TMUX" ]; then
    TERM=xterm-256color tmux new -A -s default
else
    if [[ "$TERM" =~ tmux ]]; then
        echo "Error starting tmux!"
    fi
fi

